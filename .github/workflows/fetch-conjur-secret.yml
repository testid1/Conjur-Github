name: Fetch Conjur Secret
on:
  push:
    branches: [ main ]

jobs:
  retrieve-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install curl and jq
        run: sudo apt-get update && sudo apt-get install -y curl jq

      - name: Authenticate to Conjur
        id: auth
        env:
          CONJUR_ACCOUNT: conjur
          CONJUR_APPLIANCE_URL: ${{ secrets.CONJUR_APPLIANCE_URL }}
          CONJUR_AUTHN_LOGIN: ${{ secrets.CONJUR_AUTHN_LOGIN }}
          CONJUR_API_KEY: ${{ secrets.CONJUR_API_KEY }}
        run: |
          set -e
          echo "Logging into Conjur..."
          FULL_AUTHN_URL="${CONJUR_APPLIANCE_URL}/api/authn/${CONJUR_ACCOUNT}/${CONJUR_AUTHN_LOGIN}/authenticate"

          # 1. Request the raw JWT (text/plain)
          RAW=$(curl -s \
            --request POST \
            --header "Content-Type: text/plain" \
            --header "Accept: text/plain" \
            --data "${CONJUR_API_KEY}" \
            "${FULL_AUTHN_URL}")

          # 2. Split off the HTTP status code
          BODY=$(echo "$RAW" | head -n -1)    # the full JWT
          STATUS=$(echo "$RAW" | tail -n1)

          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Authentication failed (HTTP $STATUS)"
            echo "$BODY"
            exit 1
          fi

          # 3. BODY is the complete JWT
          AUTHN_TOKEN="$BODY"

          # Print the entire token
          echo "üîë Full auth token:"
          echo "$AUTHN_TOKEN"

          # Export it for later steps
          echo "auth-token=$AUTHN_TOKEN" >> $GITHUB_OUTPUT

      - name: show auth-token output
        run: |
          echo "Token via step output: ${{ steps.auth.outputs.auth-token }}"

      - name: Fetch secret
        env:
          CONJUR_ACCOUNT: conjur
          CONJUR_APPLIANCE_URL: ${{ secrets.CONJUR_APPLIANCE_URL }}
          CONJUR_VAR_KEY: ${{ secrets.CONJUR_VAR_KEY }}
        run: |
          SECRET_URL="${CONJUR_APPLIANCE_URL}/api/secrets/${CONJUR_ACCOUNT}/variable/${CONJUR_VAR_KEY}"
          echo "Fetching secret from $SECRET_URL"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            --header "Authorization: Token token=${{ steps.auth.outputs.auth-token }}" \
            "$SECRET_URL")

          BODY=$(echo "$RESPONSE" | sed '$d')
          STATUS=$(echo "$RESPONSE" | tail -n1)

          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Secret fetch failed (HTTP $STATUS)"
            echo "$BODY"
            exit 1
          fi

          echo "‚úÖ Retrieved secret:"
          echo "$BODY"
