name: Fetch Conjur Secret

on:
  push:
    branches: [ main ]

jobs:
  retrieve-secret:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install curl and jq
      run: sudo apt-get update && sudo apt-get install -y curl jq

    - name: Authenticate to Conjur and retrieve secret
      env:
        # Set CONJUR_ACCOUNT directly since you've removed it as a secret
        CONJUR_ACCOUNT: conjur
        CONJUR_APPLIANCE_URL: ${{ secrets.CONJUR_APPLIANCE_URL }}
        CONJUR_AUTHN_LOGIN: ${{ secrets.CONJUR_AUTHN_LOGIN }}
        CONJUR_API_KEY: ${{ secrets.CONJUR_API_KEY }}
      run: |
        set -e  # Fail on error
        echo "=============================="
        echo "üîê Logging into Conjur..."
        echo "Account: $CONJUR_ACCOUNT"
        echo "Appliance URL: $CONJUR_APPLIANCE_URL"
        echo "Authn Login: $CONJUR_AUTHN_LOGIN"
        echo "=============================="

        echo "‚û°Ô∏è  Authenticating..."

        # DO NOT ENCODE LOGIN ‚Äî Conjur Cloud expects raw path in URL
        AUTHN_URL="$CONJUR_APPLIANCE_URL/authn/$CONJUR_ACCOUNT/$CONJUR_AUTHN_LOGIN/authenticate"

        echo "Authn URL: $AUTHN_URL"

        RESPONSE=$(curl -s -w "\n%{http_code}" --request POST \
          --data "$CONJUR_API_KEY" "$AUTHN_URL")

        # Split response and status
        AUTHN_TOKEN=$(echo "$RESPONSE" | head -n1 | base64 | tr -d '\r\n')
        STATUS_CODE=$(echo "$RESPONSE" | tail -n1)

        echo "Response code from /authenticate: $STATUS_CODE"
        echo "Raw token (base64 encoded): $AUTHN_TOKEN"

        if [[ "$STATUS_CODE" != "200" ]]; then
          echo "‚ùå Authentication failed"
          echo "Raw response:"
          echo "$RESPONSE"
          exit 1
        fi

        echo "‚úÖ Authentication successful!"
        echo "=============================="

        echo "‚û°Ô∏è  Fetching secret..."

        # Define your secret path
        RAW_PATH="data/vault/conjurtest/mysecret/password"
        ENCODED_PATH=$(echo "$RAW_PATH" | sed 's/\//%2F/g')

        SECRET_URL="$CONJUR_APPLIANCE_URL/secrets/$CONJUR_ACCOUNT/variable/$ENCODED_PATH"
        echo "Secret fetch URL: $SECRET_URL"

        SECRET=$(curl -s -w "\n%{http_code}" \
          -H "Authorization: Token token=\"$AUTHN_TOKEN\"" \
          "$SECRET_URL")

        SECRET_VALUE=$(echo "$SECRET" | head -n1)
        SECRET_STATUS=$(echo "$SECRET" | tail -n1)

        echo "Secret fetch status: $SECRET_STATUS"
        if [[ "$SECRET_STATUS" != "200" ]]; then
          echo "‚ùå Failed to fetch secret"
          echo "Response:"
          echo "$SECRET"
          exit 1
        fi

        echo "‚úÖ Retrieved secret: $SECRET_VALUE"
