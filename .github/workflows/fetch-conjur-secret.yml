name: Fetch Conjur Secret
on:
  push:
    branches: [ main ]
jobs:
  retrieve-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install curl and jq
        run: sudo apt-get update && sudo apt-get install -y curl jq

      - name: Authenticate to Conjur
        id: auth          # give this step an ID so we can export its output
        env:
          CONJUR_ACCOUNT: conjur
          CONJUR_APPLIANCE_URL: ${{ secrets.CONJUR_APPLIANCE_URL }}
          CONJUR_AUTHN_LOGIN: ${{ secrets.CONJUR_AUTHN_LOGIN }}
          CONJUR_API_KEY: ${{ secrets.CONJUR_API_KEY }}
        run: |
          set -e

          echo "Logging into Conjur..."
          FULL_AUTHN_URL="${CONJUR_APPLIANCE_URL}/api/authn/${CONJUR_ACCOUNT}/${CONJUR_AUTHN_LOGIN}/authenticate"

          # 1. POST API key to get raw response
          RAW=$(curl -s -i \
            --request POST \
            --header "Content-Type: text/plain" \
            --data "${CONJUR_API_KEY}" \
            "${FULL_AUTHN_URL}")

          STATUS=$(echo "$RAW" | tail -n1)
          BODY=$(echo "$RAW" | sed -n '/^\r\{0,1\}$/,$p' | sed '$d')

          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Authentication failed (HTTP $STATUS)"
            echo "$BODY"
            exit 1
          fi

          # 2. Extract JWT
          AUTHN_TOKEN=$(echo "$BODY" | jq -r '.protected + "." + .payload + "." + .signature')
          if [ -z "$AUTHN_TOKEN" ] || [ "$AUTHN_TOKEN" = "null..null" ]; then
            echo "‚ùå Token extraction failed."
            exit 1
          fi

          # 3. Export as step output and print it in full
          echo "auth-token=${AUTHN_TOKEN}" >> $GITHUB_OUTPUT
          echo "üîë Full auth token: ${AUTHN_TOKEN}"

      - name: show auth-token output
        run: |
          echo "Token via step output: ${{ steps.auth.outputs.auth-token }}"

      - name: Fetch secret
        env:
          CONJUR_ACCOUNT: conjur
          CONJUR_APPLIANCE_URL: ${{ secrets.CONJUR_APPLIANCE_URL }}
          CONJUR_VAR_KEY: ${{ secrets.CONJUR_VAR_KEY }}
        run: |
          SECRET_URL="${CONJUR_APPLIANCE_URL}/api/secrets/${CONJUR_ACCOUNT}/variable/${CONJUR_VAR_KEY}"
          echo "Fetching secret from $SECRET_URL"
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            --header "Authorization: Token token=${{ steps.auth.outputs.auth-token }}" \
            "$SECRET_URL")

          BODY=$(echo "$RESPONSE" | sed '$d')
          STATUS=$(echo "$RESPONSE" | tail -n1)

          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Secret fetch failed (HTTP $STATUS)"
            echo "$BODY"
            exit 1
          fi

          echo "‚úÖ Retrieved secret:"
          echo "$BODY"
